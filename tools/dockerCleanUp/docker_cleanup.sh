#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ root –ø—Ä–∞–≤
if [[ $EUID -ne 0 ]]; then
   echo "‚õîÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root." 
   exit 1
fi

# –≠–º–æ–¥–∑–∏ –∏ —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —à–∞–≥–æ–≤
GREEN="\033[32m"
RED="\033[31m"
CYAN="\033[36m"
RESET="\033[0m"

echo -e "${CYAN}üöÄ –ù–∞—á–∞–ª–æ –æ—á–∏—Å—Ç–∫–∏ Docker...${RESET}"

# –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo -e "${GREEN}üßπ –®–∞–≥ 1: –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${RESET}"
sudo docker container prune -f
echo -e "${CYAN}‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã.${RESET}"

# –®–∞–≥ 2: –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤
echo -e "${GREEN}üßπ –®–∞–≥ 2: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤...${RESET}"
sudo docker image prune -a -f
echo -e "${CYAN}‚úÖ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã.${RESET}"

# –®–∞–≥ 3: –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–æ–º–æ–≤
echo -e "${GREEN}üßπ –®–∞–≥ 3: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–æ–º–æ–≤...${RESET}"
sudo docker volume prune -f
echo -e "${CYAN}‚úÖ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–æ–º–∞ —É–¥–∞–ª–µ–Ω—ã.${RESET}"

# –®–∞–≥ 4: –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–µ—Ç–µ–π
echo -e "${GREEN}üßπ –®–∞–≥ 4: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–µ—Ç–µ–π...${RESET}"
sudo docker network prune -f
echo -e "${CYAN}‚úÖ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ç–∏ —É–¥–∞–ª–µ–Ω—ã.${RESET}"

# –®–∞–≥ 5: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
echo -e "${GREEN}üßπ –®–∞–≥ 5: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã Docker...${RESET}"
sudo docker system prune -a --volumes -f
echo -e "${CYAN}‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.${RESET}"

# –®–∞–≥ 6: –ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–ª–æ–µ–≤
echo -e "${GREEN}üßπ –®–∞–≥ 6: –ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –±–æ–ª—å—à–∏—Ö —Å–ª–æ–µ–≤...${RESET}"
MIN_SIZE="+100M"
find /var/lib/docker/overlay2/ -type d -size $MIN_SIZE | while read dir; do
    layer_id=$(basename "$dir")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤—è–∑–∞–Ω –ª–∏ —Å–ª–æ–π —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
    container_check=$(sudo docker ps -a --filter "id=$layer_id" --format '{{.ID}}')
    
    if [[ -z "$container_check" ]]; then
        echo -e "üì¶ –°–ª–æ–π ${layer_id} –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –£–¥–∞–ª—è–µ–º..."
        sudo rm -rf "$dir"
        echo -e "${CYAN}‚úÖ –°–ª–æ–π ${layer_id} —É–¥–∞–ª—ë–Ω.${RESET}"
    else
        echo -e "üîó –°–ª–æ–π ${layer_id} –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º..."
    fi
done

echo -e "${GREEN}üéâ –û—á–∏—Å—Ç–∫–∞ Docker –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${RESET}"
