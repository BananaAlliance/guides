#!/bin/bash

echo "-----------------------------------------------------------------------------"
curl -s https://raw.githubusercontent.com/BananaAlliance/tools/main/logo.sh | bash
echo "-----------------------------------------------------------------------------"


function print_step() {
  echo -e "\033[1;34m==================================================\033[0m"
  echo -e "\033[1;33m$1\033[0m"
  echo -e "\033[1;34m==================================================\033[0m"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð°Ð½Ð¸Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐ¿Ð¸Ð½Ð½ÐµÑ€Ð°
function spinner() {
  local pid=$1
  local delay=0.1
  local spinstr='|/-\\'
  echo -n " "
  while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    local spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  printf "    \b\b\b\b"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð°Ð½Ð¸Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð±Ð°Ð½Ð½ÐµÑ€Ð°
function print_banner() {
  echo "ðŸŒŸðŸŒŸðŸŒŸ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº Allora Node ðŸŒŸðŸŒŸðŸŒŸ"
  sleep 1
  echo "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ Ð²Ð°Ð¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹."
  echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼Ð¸ Ð½Ð° ÑÐºÑ€Ð°Ð½Ðµ Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ Ð¾Ð¿Ñ‹Ñ‚Ð°."
  echo ""
}

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼
function handle_error() {
  local step=$1
  echo "âš ï¸ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ: '$step'"
  echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ ÐÐ»ÑŒÑÐ½ÑÐ° Ð½Ð¾Ð´ Ð´Ð»Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð¸."
  exit 1
}

# Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
function load_environment() {
  source .profile || handle_error "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ"
  print_step
  echo "ðŸ”„ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ... ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ."
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð¸ Go
function install_essential_packages_and_go() {
    echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
    sleep 2
    sudo apt update || handle_error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²"

    echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
    sleep 2
    sudo apt install mc jq curl build-essential git wget git lz4 -y || handle_error "ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²"

    echo "ðŸ—‘ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Go (ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°)..."
    sleep 2
    sudo rm -rf /usr/local/go

    echo "ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Go 1.22.4..."
    sleep 2
    curl https://dl.google.com/go/go1.22.4.linux-amd64.tar.gz | sudo tar -C /usr/local -zxvf - || handle_error "ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Go"

    echo "âš™ï¸ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Go..."
    {
        echo "export GOROOT=/usr/local/go"
        echo "export GOPATH=$HOME/go"
        echo "export GO111MODULE=on"
        echo "export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin"
    } >> $HOME/.profile || handle_error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ .profile Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Go"

    echo "ðŸ”„ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ Ð² .profile..."
    sleep 2
    source $HOME/.profile || handle_error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð² .profile"

    echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° GO Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾."
    sleep 2
}

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker, ÐµÑÐ»Ð¸ Ð¾Ð½ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
function install_docker() {
  if ! command -v docker &> /dev/null; then
    echo "ðŸ³ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Docker. Ð˜Ð½Ð¸Ñ†Ð¸Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ..."
    sudo install -m 0755 -d /etc/apt/keyrings
    for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done
    sudo apt-get update
    sudo apt-get install ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    sudo apt-get update
    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin screen
    echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾."
    sleep 2
  else
    echo "ðŸ³ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°: Docker ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½."
    sleep 2
  fi
}

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Go, ÐµÑÐ»Ð¸ Ð²ÐµÑ€ÑÐ¸Ñ Ð½Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼
function install_go() {
  local required_major_version=1
  local required_minor_version=22

  if command -v go &> /dev/null; then
    local go_version=$(go version | awk '{print $3}' | cut -d 'o' -f 2)
    local major_version=$(echo "$go_version" | cut -d '.' -f 1)
    local minor_version=$(echo "$go_version" | cut -d '.' -f 2)

    if [[ "$major_version" -lt "$required_major_version" ]] || { [[ "$major_version" -eq "$required_major_version" ]] && [[ "$minor_version" -lt "$required_minor_version" ]]; }; then
      echo "ðŸ”§ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Go Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸."
      install_essential_packages_and_go
      echo "ðŸ”§ Go ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½."
      sleep 2
    else
      echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°: Ð¢Ñ€ÐµÐ±ÑƒÐµÐ¼Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Go ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°."
      sleep 2
    fi
  else
    echo "ðŸ”§ Go Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ..."
    sleep 2
    install_essential_packages_and_go
    echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Go Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾."
    sleep 2
  fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ, ÐµÑÐ»Ð¸ Ð¾Ð½ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
function clone_or_update_repo() {
  local repo_path="$HOME/allora-chain"
  local repo_url="https://github.com/allora-network/allora-chain.git"

  echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð¾ Ð¿ÑƒÑ‚Ð¸: $repo_path"
  if [ -d "$repo_path" ]; then
    echo "ðŸ“ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚. ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ..."
    cd "$repo_path" && git pull || handle_error "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ"
    echo "ðŸ”„ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½."
    sleep 2
  else
    git clone "$repo_url" "$repo_path" && cd "$repo_path" || handle_error "ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ"
    echo "ðŸŽ‰ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½."
    sleep 2
  fi
}

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð½Ð¾Ð´Ñ‹
function install_node() {
  print_step
  echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð½Ð¾Ð´Ñ‹ Allora..."
  install_docker
  install_go

  clone_or_update_repo && cd $HOME/allora-chain
  sed -i 's/^go 1.22.2$/go 1.22/' go.mod || handle_error "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ go.mod"
  make all || handle_error "Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Allora"
  print_step
  echo "ðŸ‘· Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Allora Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾."
  sleep 2

  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÑ€ÑÐ¸Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð¾Ð¹ Ð½Ð¾Ð´Ñ‹
  print_step

  if allorad version; then
    echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ð½Ð¾Ð´Ñ‹: $(allorad version)"
    echo "ðŸ”‘ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ seed Ñ„Ñ€Ð°Ð·Ñƒ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ°:"
    allorad keys add testkey --recover
    #echo "ðŸ”‘ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ°:"
    #echo "    source .profile && allorad keys add testkey"
    #echo "ðŸ“ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ ÑÐ¸Ð´-Ñ„Ñ€Ð°Ð·Ñƒ, Ð°Ð´Ñ€ÐµÑ Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ."
  else
    handle_error "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÑ€ÑÐ¸Ð¸ Ð½Ð¾Ð´Ñ‹"
  fi
}

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð´Ñ‹
function remove_node() {
  echo "ðŸ—‘ Ð˜Ð½Ð¸Ñ†Ð¸Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð½Ð¾Ð´Ñ‹ Allora..."
  rm -rf $HOME/allora-chain || handle_error "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð´Ñ‹"
  echo "ðŸ§¹ ÐÐ¾Ð´Ð° Allora ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð°."
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ ÑƒÐ·Ð»Ð° (Ð²Ð¾Ñ€ÐºÐµÑ€Ð°)
function setup_worker() {
  print_step
  echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ ÑƒÐ·Ð»Ð° Ð´Ð»Ñ Allora..."
  echo "ðŸ”‘ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¸Ð´-Ñ„Ñ€Ð°Ð·Ñƒ Ð´Ð»Ñ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ° Ð²Ð¾Ñ€ÐºÐµÑ€Ð°:"
  read seed_phrase

  print_step

  if [ -d "$HOME/basic-coin-prediction-node" ]; then
    cd $HOME && cd basic-coin-prediction-node
    docker compose down -v
    docker container prune
    echo "âš ï¸ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ basic-coin-prediction-node ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚. Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐµÑ‘? (y/n):"
    read -r delete_dir
    if [ "$delete_dir" == "y" ]; then
      rm -rf "$HOME/basic-coin-prediction-node" || handle_error "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸"
    else
      echo "âŒ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€ÐµÑ€Ð²Ð°Ð½Ð°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐ´Ð°Ð»Ð¸Ñ‚Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ."
      exit 1
    fi
  fi

  cd $HOME && git clone https://github.com/allora-network/basic-coin-prediction-node || handle_error "ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð²Ð¾Ñ€ÐºÐµÑ€Ð°"

  sleep 10

  cd $HOME

  # ÐÐ¾Ð²Ñ‹Ðµ ÑˆÐ°Ð³Ð¸
  cd basic-coin-prediction-node

  # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° config.json Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
  cat > config.json <<EOL
{
    "wallet": {
        "addressKeyName": "testkey",
        "addressRestoreMnemonic": "$seed_phrase",
        "alloraHomeDir": "",
        "gas": "1000000",
        "gasAdjustment": 1.0,
        "nodeRpc": "https://sentries-rpc.testnet-1.testnet.allora.network/",
        "maxRetries": 1,
        "delay": 1,
        "submitTx": false
    },
    "worker": [
        {
            "topicId": 1,
            "inferenceEntrypointName": "api-worker-reputer",
            "loopSeconds": 5,
            "parameters": {
                "InferenceEndpoint": "http://inference:8000/inference/{Token}",
                "Token": "ETH"
            }
        },
        {
            "topicId": 2,
            "inferenceEntrypointName": "api-worker-reputer",
            "loopSeconds": 5,
            "parameters": {
                "InferenceEndpoint": "http://inference:8000/inference/{Token}",
                "Token": "ETH"
            }
        },
        {
            "topicId": 7,
            "inferenceEntrypointName": "api-worker-reputer",
            "loopSeconds": 5,
            "parameters": {
                "InferenceEndpoint": "http://inference:8000/inference/{Token}",
                "Token": "ETH"
            }
        }
    ]
}
EOL

  # ÐŸÑ€Ð¸ÑÐ²Ð¾ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¸ Ð·Ð°Ð¿ÑƒÑÐº init.config
  chmod +x init.config || handle_error "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ init.config"
  ./init.config || handle_error "Ð—Ð°Ð¿ÑƒÑÐº init.config"

  # ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» model.py Ð¸ Ð¼ÐµÐ½ÑÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ñ intervals
  sed -i 's/intervals = .*/intervals = ["10m", "20m", "1h", "1d"]/' model.py || handle_error "Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ intervals Ð² model.py"

  # Ð—Ð°Ð¿ÑƒÑÐº Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
  docker compose up -d --build & spinner $! || handle_error "Ð—Ð°Ð¿ÑƒÑÐº Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ° Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²"

  print_step

  echo "ðŸš€ Ð’Ð°Ñˆ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ ÑƒÐ·ÐµÐ» Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½."
}

# Ð’Ñ‹Ð²Ð¾Ð´ Ð»Ð¾Ð³Ð¾Ð²
function show_logs() {
  echo "ðŸ“œ ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð»Ð¾Ð³Ð¾Ð² Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð½Ð¾Ð´Ñ‹ Allora..."
  docker compose logs -f worker || handle_error "Ð’Ñ‹Ð²Ð¾Ð´ Ð»Ð¾Ð³Ð¾Ð² Ð²Ð¾Ñ€ÐºÐµÑ€Ð°"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð½Ð¾Ð´Ñ‹
function check_node_status() {
  echo "ðŸ”„ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð½Ð¾Ð´Ñ‹ Allora..."
  curl --location 'http://localhost:6000/api/v1/functions/execute' \
    --header 'Content-Type: application/json' \
    --data '{
      "function_id": "bafybeigpiwl3o73zvvl6dxdqu7zqcub5mhg65jiky2xqb4rdhfmikswzqm",
      "method": "allora-inference-function.wasm",
      "parameters": null,
      "topic": "1",
      "config": {
        "env_vars": [
          {
            "name": "BLS_REQUEST_PATH",
            "value": "/api"
          },
          {
            "name": "ALLORA_ARG_PARAMS",
            "value": "ETH"Æ’
          }
        ],
        "number_of_nodes": -1,
        "timeout": 10
      }
    }' || handle_error "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð½Ð¾Ð´Ñ‹"
}

# Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸
function main() {
  print_banner
  local action="$1"

  case "$action" in
    "install")
      install_node
      ;;
    "status")
      check_node_status
      ;;
    "remove")
      remove_node
      ;;
    "setup-worker")
      setup_worker
      ;;
    "show-logs")
      show_logs
      ;;
    *)
      echo "âš ï¸ Ð£ÐºÐ°Ð·Ð°Ð½Ð¾ Ð½ÐµÐ²ÐµÑ€Ð½Ð¾Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: $action. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¾Ð¿Ñ†Ð¸Ð¸: 'install', 'remove', 'setup-worker', 'show-logs'"
      exit 2
      ;;
  esac
}

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ñ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
main "$@"